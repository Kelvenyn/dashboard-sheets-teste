<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leitor do Antigo Testamento ‚Äì √Årea de Membros</title>
  <meta name="theme-color" content="#0ea5e9" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root { color-scheme: light dark; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  </style>

  <!-- PDF.js (somente para o FLIPBOOK / render local) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>

  <!-- StPageFlip (efeito virar p√°gina) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/stpageflip@2.0.7/dist/css/page-flip.min.css" />
  <script defer src="https://cdn.jsdelivr.net/npm/stpageflip@2.0.7/dist/js/page-flip.browser.min.js"></script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-30 border-b border-slate-200/70 dark:border-slate-800/80 bg-white/80 dark:bg-slate-900/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-10 h-10 rounded-2xl bg-sky-500/10 flex items-center justify-center ring-1 ring-sky-400/30">
        <span class="text-sky-600 font-extrabold">AT</span>
      </div>
      <div class="flex-1">
        <h1 class="text-lg sm:text-xl font-bold">Antigo Testamento ‚Äì √Årea de Leitura</h1>
        <p class="text-slate-500 text-sm">Modo Leitor (Google Drive) e modo Flipbook</p>
      </div>
      <a href="https://wa.me/5579981373200" target="_blank" class="px-3 py-2 rounded-xl bg-green-500 hover:bg-green-600 text-white text-sm font-semibold shadow">Suporte WhatsApp</a>
    </div>
  </header>

  <!-- Tabs -->
  <main class="max-w-6xl mx-auto px-4 py-6">
    <div class="inline-flex rounded-2xl p-1 bg-slate-100 dark:bg-slate-800 shadow-sm">
      <button id="tabReader" class="px-4 py-2 rounded-xl text-sm font-semibold bg-white dark:bg-slate-900 shadow">üìñ Leitor</button>
      <button id="tabFlip" class="px-4 py-2 rounded-xl text-sm font-semibold text-slate-600 dark:text-slate-300">üìö Flipbook</button>
    </div>

    <!-- Aviso Drive -->
    <div class="mt-4 text-xs text-slate-500 space-y-1">
      <p>Fonte atual: <b>Google Drive</b>. Para arquivos muito grandes, o Drive pode bloquear downloads diretos por seguran√ßa (sem CORS), o que quebra o PDF.js e gera <code>Failed to fetch</code>.</p>
      <p>‚úÖ Corrigido: o <b>Modo Leitor</b> agora usa o <em>preview</em> oficial do Drive e funciona mesmo com arquivos grandes.</p>
      <p>‚ÑπÔ∏è O <b>Flipbook</b> precisa que o PDF esteja em servidor com CORS (ex.: S3/Cloudflare R2). Inclu√≠mos um <b>teste de exemplo</b> e op√ß√£o de URL pr√≥pria.</p>
    </div>

    <!-- PANELS -->
    <section id="panelReader" class="mt-6">
      <div class="rounded-2xl overflow-hidden ring-1 ring-slate-200 dark:ring-slate-800 shadow-lg">
        <!-- Drive Preview embutido (funciona sem CORS) -->
        <iframe id="drivePreview" title="Leitor PDF (Drive)" class="w-full" style="height: calc(100vh - 180px);" allow="fullscreen" referrerpolicy="no-referrer"></iframe>
      </div>
      <div class="flex items-center justify-between mt-3 text-xs text-slate-500">
        <span>Se preferir, abra em nova aba.</span>
        <div class="space-x-2">
          <a id="openPreview" target="_blank" class="underline">Abrir preview</a>
          <a id="openDownload" target="_blank" class="underline">Baixar (se permitido)</a>
        </div>
      </div>
    </section>

    <section id="panelFlip" class="mt-6 hidden">
      <div class="rounded-2xl ring-1 ring-slate-200 dark:ring-slate-800 shadow-lg p-4 sm:p-6 bg-white dark:bg-slate-900">
        <!-- Seletor de fonte para o Flipbook -->
        <div class="flex flex-wrap items-center gap-3">
          <span class="text-sm text-slate-600 dark:text-slate-300">Fonte do PDF para o Flipbook:</span>
          <button id="useDemo" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-sm">Usar DEMO (teste)</button>
          <button id="useDrive" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-sm">Tentar Google Drive</button>
          <div class="flex items-center gap-2 text-sm">
            <input id="customUrl" type="url" placeholder="Cole uma URL direta (CORS liberado)" class="w-[320px] max-w-full px-3 py-2 rounded-xl bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700"/>
            <button id="useCustom" class="px-3 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-white text-sm font-semibold">Usar URL</button>
          </div>
        </div>

        <p class="mt-3 text-xs text-slate-500" id="flipHint">Dica: para usar seu PDF gigante no flipbook, hospede em S3/R2 com CORS e copie a URL. Com Drive, pode falhar.</p>

        <div class="flex items-center justify-between flex-wrap gap-3 mt-4">
          <div class="flex items-center gap-3">
            <button id="btnPrev" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-sm">‚Üê Anterior</button>
            <button id="btnNext" class="px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-sm">Pr√≥xima ‚Üí</button>
          </div>
          <div class="text-sm text-slate-500" id="flipInfo">Selecione uma fonte para iniciar‚Ä¶</div>
        </div>

        <div id="flipContainer" class="mt-4 mx-auto" style="width: min(100%, 900px); height: min(80vh, 1200px);"></div>

        <div class="mt-4 flex items-center justify-between">
          <button id="btnLoadMore" class="px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-white text-sm font-semibold disabled:opacity-50" disabled>Carregar mais p√°ginas</button>
          <label class="text-sm flex items-center gap-2"><input id="chkRetina" type="checkbox" class="accent-sky-500" checked> Qualidade alta</label>
        </div>
      </div>
    </section>
  </main>

  <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-xs text-slate-500">
    ¬© <span id="year"></span> Kelvenyn ‚Äì Leitor do Antigo Testamento. Todos os direitos reservados.
  </footer>

  <script>
    // ====== CONFIGURA√á√ïES ======
    const DRIVE_FILE_ID = '1rnK1TAJDXbKqFrjQLsYam90r170sBqDD';
    const DRIVE_PREVIEW_URL = `https://drive.google.com/file/d/${DRIVE_FILE_ID}/preview`;
    const DRIVE_DOWNLOAD_URL = `https://drive.google.com/uc?export=download&id=${DRIVE_FILE_ID}`; // pode exigir confirma√ß√£o em arquivos grandes

    // PDF DEMO (CORS liberado) ‚Äì usado como "teste autom√°tico" do flipbook
    const DEMO_PDF_URL = 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf';

    // ====== TABS ======
    const tabReader = document.getElementById('tabReader');
    const tabFlip   = document.getElementById('tabFlip');
    const panelReader = document.getElementById('panelReader');
    const panelFlip   = document.getElementById('panelFlip');

    function activate(tab){
      if(tab === 'reader'){
        tabReader.classList.add('bg-white','dark:bg-slate-900','shadow');
        tabReader.classList.remove('text-slate-600','dark:text-slate-300');
        tabFlip.classList.remove('bg-white','dark:bg-slate-900','shadow');
        tabFlip.classList.add('text-slate-600','dark:text-slate-300');
        panelReader.classList.remove('hidden');
        panelFlip.classList.add('hidden');
      } else {
        tabFlip.classList.add('bg-white','dark:bg-slate-900','shadow');
        tabFlip.classList.remove('text-slate-600','dark:text-slate-300');
        tabReader.classList.remove('bg-white','dark:bg-slate-900','shadow');
        tabReader.classList.add('text-slate-600','dark:text-slate-300');
        panelFlip.classList.remove('hidden');
        panelReader.classList.add('hidden');
      }
    }
    tabReader.addEventListener('click', ()=>activate('reader'));
    tabFlip.addEventListener('click', ()=>activate('flip'));

    // ====== MODO LEITOR (Drive Preview) ======
    const preview = document.getElementById('drivePreview');
    const openPreview = document.getElementById('openPreview');
    const openDownload = document.getElementById('openDownload');
    preview.src = DRIVE_PREVIEW_URL + '#zoom=page-fit';
    openPreview.href = `https://drive.google.com/file/d/${DRIVE_FILE_ID}/view`;
    openDownload.href = DRIVE_DOWNLOAD_URL;

    // ====== MODO FLIPBOOK ======
    const flipContainer = document.getElementById('flipContainer');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');
    const btnLoadMore = document.getElementById('btnLoadMore');
    const chkRetina = document.getElementById('chkRetina');
    const flipInfo = document.getElementById('flipInfo');

    // Seletor de fonte
    const useDemo = document.getElementById('useDemo');
    const useDrive = document.getElementById('useDrive');
    const useCustom = document.getElementById('useCustom');
    const customUrl = document.getElementById('customUrl');

    let pdfDoc = null;
    let pageCount = 0;
    let loadedPages = 0;
    let flip = null;
    const BATCH_SIZE = 12; // carrega 12 p√°ginas por vez

    function resetFlip(){
      loadedPages = 0;
      pageCount = 0;
      flip?.destroy();
      flip = new St.PageFlip(flipContainer, {
        width: 900, height: 1200,
        size: 'stretch', usePortrait: true,
        maxShadowOpacity: 0.3, mobileScrollSupport: true
      });
      flipInfo.textContent = 'Preparando‚Ä¶';
      btnLoadMore.disabled = true;
    }

    async function initFlipbookFrom(url){
      try {
        resetFlip();
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const task = pdfjsLib.getDocument({ url });
        pdfDoc = await task.promise; // "Failed to fetch" aqui quando CORS/Drive bloqueia
        pageCount = pdfDoc.numPages;
        flipInfo.textContent = `P√°ginas: ${pageCount}. Renderizando primeiras ${BATCH_SIZE}‚Ä¶`;
        await queueBatch();
      } catch (err) {
        console.error(err);
        flipInfo.textContent = 'N√£o foi poss√≠vel carregar este PDF diretamente. Se ele est√° no Google Drive e √© muito grande, o acesso direto √© bloqueado. Hospede em S3/Cloudflare R2 (CORS) ou use a op√ß√£o DEMO/URL.';
      }
    }

    async function queueBatch(){
      if(!pdfDoc) return;
      const end = Math.min(loadedPages + BATCH_SIZE, pageCount);
      btnLoadMore.disabled = true;
      for(let i = loadedPages + 1; i <= end; i++){
        const page = await pdfDoc.getPage(i);
        const viewport = page.getViewport({ scale: chkRetina.checked ? 1.8 : 1.2 });
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = Math.floor(viewport.width);
        canvas.height = Math.floor(viewport.height);
        await page.render({ canvasContext: context, viewport }).promise;
        const dataURL = canvas.toDataURL('image/jpeg', 0.92);

        const pageElem = document.createElement('div');
        pageElem.className = 'page bg-white dark:bg-slate-900';
        const img = document.createElement('img');
        img.src = dataURL; img.alt = `P√°gina ${i}`;
        img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit = 'contain';
        pageElem.appendChild(img);

        if(loadedPages === 0){ flip.loadFromHTML([pageElem]); } else { flip.addPage(pageElem); }
        loadedPages = i; flipInfo.textContent = `P√°ginas carregadas: ${loadedPages}/${pageCount}`;
      }
      btnLoadMore.disabled = loadedPages >= pageCount;
      btnLoadMore.textContent = loadedPages >= pageCount ? 'Todas as p√°ginas carregadas' : 'Carregar mais p√°ginas';
    }

    // Controles
    btnPrev.addEventListener('click', ()=> flip?.flipPrev());
    btnNext.addEventListener('click', ()=> flip?.flipNext());
    btnLoadMore.addEventListener('click', queueBatch);
    chkRetina.addEventListener('change', ()=>{ if(pdfDoc){ initFlipbookFrom(currentURL); } });

    let currentURL = null;
    useDemo.addEventListener('click', ()=>{ currentURL = DEMO_PDF_URL; initFlipbookFrom(currentURL); btnLoadMore.disabled = false; });
    useDrive.addEventListener('click', ()=>{ currentURL = DRIVE_DOWNLOAD_URL; initFlipbookFrom(currentURL); /* pode falhar em arquivos grandes (Drive) */ });
    useCustom.addEventListener('click', ()=>{
      const url = (customUrl.value || '').trim();
      if(!url) { flipInfo.textContent = 'Informe uma URL direta para o PDF.'; return; }
      currentURL = url; initFlipbookFrom(currentURL); btnLoadMore.disabled = false;
    });

    // Ano rodap√©
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>
